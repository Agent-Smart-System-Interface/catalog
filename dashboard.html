function doGet(e) {
  var mode = e.parameter.mode;
  var project = e.parameter.project;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  if (mode === "getUnitList") {
    var allData = [];
    var sheetNames = (project === "all") ? ["Project_A", "Project_B", "Project_Master"] : [project];
    
    sheetNames.forEach(function(name) {
      var sheet = ss.getSheetByName(name);
      if (sheet) {
        var values = sheet.getDataRange().getValues();
        var headers = values[0]; // แถวที่ 1 คือหัวข้อ
        
        // ค้นหาตำแหน่งคอลัมน์แบบไดนามิก
        var idxID = headers.indexOf("HP_ID");
        var idxName = headers.indexOf("ID_NAME");
        var idxSys = headers.indexOf("System_Status"); // หาคอลัมน์ System
        var idxUnit = headers.indexOf("Status"); // หาคอลัมน์ Unit Status
        
        for (var i = 1; i < values.length; i++) {
          if (values[i][idxID]) {
            allData.push({
              id: values[i][idxID],
              name: values[i][idxName],
              sysStatus: values[i][idxSys] || "Pending", // ดึงข้อมูล System
              unitStatus: values[i][idxUnit] || "Available", // ดึงข้อมูล Unit Status
              project: name
            });
          }
        }
      }
    });
    return ContentService.createTextOutput(JSON.stringify(allData)).setMimeType(ContentService.MimeType.JSON);
  }
}
